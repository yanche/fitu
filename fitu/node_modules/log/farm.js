
var fs = require('fs');
var moment = require('moment');
var timezone = require('moment-timezone');
var config = require('config');
var path = require('path');
var extension = require('extension');

var harvestDay = function () {
    var now = moment().tz('Asia/Shanghai');
    return now.format('YYYY-MM-DD') + '.fitulog';
};

var season = function (farm) {
    setTimeout(function () {
        farm.harvest();
        season(farm);
    }, farm._timeout * 1000);
};

//timeout in seconds
var Farm = function (timeout, name) {
    this._farm = [];
    this._timeout = timeout;
    this._name = name;
    if (timeout > 0)
        season(this);
};
Farm.prototype.plant = function (logEntry) {
    this._farm.push(logEntry);
    if (this.overwhelm())
        this.harvest();
};
Farm.prototype.overwhelm = function () {
    return this._farm.length > config.logOverwhelmThreshold;
};
Farm.prototype.harvest = function () {
    if (this._farm.length > 0) {
        var _oldLand = this._farm, dir = path.join(__dirname, '../../../', config.folder4logs);
        var filename = path.join(dir, (this._name ? (this._name + '_') : '') + harvestDay());
        this._farm = [];
        extension.file.mkdirp(dir)
        .then(function () {
            fs.appendFile(filename, _oldLand.map(function (e) { return e.stringify(); }).join('\r\n') + '\r\n', function (err) {
                if (err) {
                    console.log('failed to append logs, filename: ' + filename);
                    console.log(err.stack);
                }
            });
        });
    }
};

module.exports = Farm;