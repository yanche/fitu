var config = require('config');
var validate = require('validate');
var url = require('url');

var urlJoin = function () {
    var ret = '/';
    for (var i in arguments) {
        var tgt = arguments[i];
        if (typeof tgt == 'string' && tgt.length > 0) {
            if (ret[ret.length - 1] == '/') {
                if (tgt[0] == '/')
                    ret = ret + tgt.slice(1);
                else
                    ret = ret + tgt;
            }
            else if (tgt[0] == '/') {
                ret = ret + tgt;
            }
            else
                ret = ret + '/' + tgt;
        }
    }
    return arguments[0][0] == '/' ? ret : ret.slice(1);
};

var parseExternalStorageUrl = function (targeturl) {
    if (!validate.isString(targeturl))
        return false;
    if (targeturl.indexOf(config.azureStorageBase) == 0)
        return { storage: 'azure', path: targeturl.slice(config.azureStorageBase.length) };
    else if (targeturl.indexOf(config.qiniuStorageBase) == 0)
        return { storage: 'qiniu', path: targeturl.slice(config.qiniuStorageBase.length) };
    else {
        var localStorageBase = url.format(config.storageFileServer);
        if (targeturl.indexOf(localStorageBase) == 0)
            return { storage: 'local', path: targeturl.slice(localStorageBase.length) };
        else
            return false;
    }
};

exports.urlJoin = urlJoin;
exports.parseExternalStorageUrl = parseExternalStorageUrl;