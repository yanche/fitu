
var db = require('dbaccess');
var bluebird = require('bluebird');
var extension = require('extension');
var constants = require('const');
var imageUpload = require('imageUpload');
var errdef = require('errdef');
var resxutil = require('resxutil');
var config = require('config');
var Resource = require('resource');
var validate = require('validate');
var _ = require('underscore');

var userfansResFactory = function (webreq) {
    return new UserFans(webreq);
};

var UserFans = function (webreq) {
    Resource.call(this, webreq);
    this.filter.targetUserObjId = extension.mongo.tryConvObjId(webreq.search.userId);
};

UserFans.prototype = Object.create(Resource.prototype);

UserFans.prototype._accessibility = function () {
    var me = this;
    var httpOptions = new resxutil.HttpOptions();
    if (me.filter.targetUserObjId) {
        if (me.operator) {
            if (!me.operator.objId.equals(me.filter.targetUserObjId))
                return bluebird.resolve(httpOptions.setStatus('GET', 200).setStatus('POST', 200).setStatus('DELETE', 200));
            else
                return bluebird.resolve(httpOptions.setStatus('GET', 400).setStatus('POST', 400).setStatus('DELETE', 400));
        }
        else
            return bluebird.resolve(httpOptions.setStatus('GET', 401).setStatus('POST', 401).setStatus('DELETE', 401));
    }
    else
        return bluebird.resolve(httpOptions.setStatus('GET', 400).setStatus('POST', 400).setStatus('DELETE', 400));
};

//{fan:, subscribed: }
UserFans.prototype._get = function () {
    var me = this;
    return me._accessibility()
    .then(function (httpOptions) {
        var status = httpOptions.getStatus('GET');
        if (status.isOK())
            return db.user.getOneUserFieldsBy({ _id: me.operator.objId }, { fans: 1, 'subscribe.users': 1 });
        else
            throw new errdef.DeferChainKiller(status.toWebres());
    })
    .then(function (self) {
        var isSubscribedBy = self.fans.some(function (f) { return f.equals(me.filter.targetUserObjId); });
        var isFanOf = self.subscribe.users.some(function (s) { return s.equals(me.filter.targetUserObjId); });
        return extension.http.webres200(constants.mime.json, JSON.stringify({ fan: isFanOf, subscribed: isSubscribedBy }));
    })
    .catch(errdef.DeferChainKiller, function (err) {
        return err.attach;
    });
};

UserFans.prototype._post = function () {
    var me = this;
    return me._accessibility()
    .then(function (httpOptions) {
        var status = httpOptions.getStatus('POST');
        if (status.isOK())
            return db.user.getOneUserFieldsBy({ _id: me.filter.targetUserObjId }, { _id: 1 });
        else
            throw new errdef.DeferChainKiller(status.toWebres());
    })
    .then(function (user) {
        if (user) {
            return bluebird.all([
                db.user.updateUsers({ _id: me.operator.objId }, { $addToSet: { 'subscribe.users': me.filter.targetUserObjId } }),
                db.user.updateUsers({ _id: me.filter.targetUserObjId }, { $addToSet: { fans: me.operator.objId } })
            ]);
        }
        else
            throw new errdef.DeferChainKiller(extension.http.webres404());
    })
    .then(function () {
        return extension.http.webres201(constants.mime.plain, '');
    })
    .catch(errdef.DeferChainKiller, function (err) {
        return err.attach;
    });
};

UserFans.prototype._delete = function () {
    var me = this;
    return me._accessibility()
    .then(function (httpOptions) {
        var status = httpOptions.getStatus('DELETE');
        if (status.isOK()) {
            return bluebird.all([
                db.user.updateUsers({ _id: me.operator.objId }, { $pull: { 'subscribe.users': me.filter.targetUserObjId } }),
                db.user.updateUsers({ _id: me.filter.targetUserObjId }, { $pull: { fans: me.operator.objId } })
            ]);
        }
        else
            throw new errdef.DeferChainKiller(status.toWebres());
    })
    .then(function () {
        return extension.http.webres200(constants.mime.plain, '');
    })
    .catch(errdef.DeferChainKiller, function (err) {
        return err.attach;
    });
};

module.exports = userfansResFactory;
