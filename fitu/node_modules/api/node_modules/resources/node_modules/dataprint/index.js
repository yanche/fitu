
var db = require('dbaccess');
var bluebird = require('bluebird');
var extension = require('extension');
var constants = require('const');
var errdef = require('errdef');
var config = require('config');
var Resource = require('resource');
var validate = require('validate');
var infra = require('infra');
var resxutil = require('resxutil');
var dputil = require('./dataprintutil.js');

var DataPrint = function (webreq) {
    Resource.call(this, webreq);
    this.filter.type = webreq.search.type;
    this.targetdb = targetdbs[this.filter.type];
    this.filter.timespan = Number(webreq.search.timespan);
};

DataPrint.prototype = Object.create(Resource.prototype);

DataPrint.prototype._accessibility = function () {
    var httpOptions = new resxutil.HttpOptions();
    var me = this;
    if (!me.operator)
        return bluebird.resolve(httpOptions.setStatus('GET', 401));
    else if (!validate.number(me.filter.timespan) || me.filter.timespan <= 0 || !me.targetdb)
        return bluebird.resolve(httpOptions.setStatus('GET', 400));
    else {
        return me.operator.isGodOrOb()
        .then(function (ok) {
            return httpOptions.setStatus('GET', ok ? 200 : 401);
        });
    }
};

DataPrint.prototype._get = function () {
    var me = this;
    return me._accessibility()
    .then(function (httpOptions) {
        var status = httpOptions.getStatus('GET');
        if (status.isOK()) {
            var startDate = extension.datetime.getDateWithOffset({ days: -me.filter.timespan });
            return me.targetdb.mapReduce(dputil.mapFnByCreatedOn, dputil.reduceFnByCreatedOn, { createdOn: { $gte: startDate } });
        }
        else
            throw new errdef.DeferChainKiller(status.toWebres());
    })
    .then(function (data) {
        return extension.http.webres200(constants.mime.json, JSON.stringify(data));
    })
    .catch(errdef.DeferChainKiller, function (err) {
        return err.attach;
    });
};

var targetdbs = {
    user: db.user,
    activity: db.activity,
    site: db.site,
    vendor: db.vendor
};

module.exports = function (webreq) {
    return new DataPrint(webreq);
};