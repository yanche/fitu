
var db = require('dbaccess');
var bluebird = require('bluebird');
var extension = require('extension');
var constants = require('const');
var imageUpload = require('imageUpload');
var errdef = require('errdef');
var resxutil = require('resxutil');
var config = require('config');
var Resource = require('resource');
var validate = require('validate');
var _ = require('underscore');

/*
list: [{
'id':,
'name':,
'tags': [],
'location':{
	'address':,
	'geo': {lat:, lng:},
	},
'prices': [{'amount', 'freq': {'num':, 'measure': }, 'comments': }],
'open': {'startsOn': {hour:, min: }, 'endsOn': {hour:, min: } },
'contact':,
'intro':,
'picUrl':,
'vendor': {id:, name:, logoUrl: },
'statusId':,
}],
total:
*/
var Sites = function (webreq) {
    var me = this;
    Resource.call(me, webreq);
    me.filter.vendorObjId = extension.mongo.tryConvObjId(webreq.search.vendorId);
    me.filter.subscribedSitesOfObjId = extension.mongo.tryConvObjId(webreq.search.subscribedSitesOf);
    me.filter.tag = webreq.search.tag;
    me.filter.active = Boolean(webreq.search.active);
    me.badFilter = (webreq.search.vendorId && !me.filter.vendorObjId) || (webreq.search.subscribedSitesOf && !me.filter.subscribedSitesOfObjId);
    me.pageSize = extension.pagination.convPageSize(webreq.search.pageSize, config.pageSize.sites.max, config.pageSize.sites.min, config.pageSize.sites.default);
    me.page = extension.pagination.convPage(webreq.search.page); //page starts from 0
};

Sites.prototype = Object.create(Resource.prototype);

Sites.prototype._accessibility = function () {
    var httpOptions = new resxutil.HttpOptions();
    var me = this;
    if (me.badFilter)
        return bluebird.resolve(httpOptions.setStatus('GET', 400).setStatus('POST', 400));
    if (!me.operator)
        return bluebird.resolve(httpOptions.setStatus('GET', me.filter.subscribedSitesOfObjId ? 401 : 200).setStatus('POST', 401));
    httpOptions.setStatus('GET', 200);
    return me.filter.vendorObjId ? me.operator.isGod()
    .then(function (ok) {
        if (ok)
            return httpOptions.setStatus('POST', 200);
        else {
            return me.operator.vendorWritable(me.filter.vendorObjId)
            .then(function (ok) {
                return httpOptions.setStatus('POST', ok ? 200 : 401);
            });
        }
    }) : bluebird.resolve(httpOptions.setStatus('POST', 200));
};

Sites.prototype._get = function () {
    var me = this, sites = null, total = 0;
    return me._accessibility()
    .then(function (httpOptions) {
        var status = httpOptions.getStatus('GET');
        if (status.isOK()) {
            if (me.filter.subscribedSitesOfObjId)
                return db.user.getOneUserFieldsBy({ _id: me.filter.subscribedSitesOfObjId }, { 'subscribe.sites': 1 });
            else
                return null;
        }
        else
            throw new errdef.DeferChainKiller(status.toWebres());
    })
    .then(function (fan) {
        if (me.filter.subscribedSitesOfObjId && !fan)
            throw new errdef.DeferChainKiller(extension.http.webres404());
        else {
            var filter = {};
            if (me.filter.vendorObjId) filter.vendorId = me.filter.vendorObjId;
            if (fan) filter._id = { $in: fan.subscribe.sites };
            if (me.filter.tag) filter.tags = me.filter.tag;
            if (me.filter.active) filter.statusId = constants.status.siteStatus.active;
            return bluebird.all([
                db.site.getSitesFieldsInPage(filter, resxutil.site.getFields, { createdOn: -1 }, me.page * me.pageSize, me.pageSize),
                db.site.countSites(filter)
            ]);
        }
    })
    .then(function (data) {
        sites = data[0], total = data[1];
        var relatedSites = sites.filter(function (st) { return st.vendorId; }).map(function (st) { return st.vendorId; });
        return relatedSites.length > 0 ? db.vendor.getVendorsFieldsBy({ _id: { $in: relatedSites } }, resxutil.vendor.getRelatedVendorFields) : [];
    })
    .then(function (vendors) {
        return sites.map(function (st) { return resxutil.site.convSiteInfo(st, vendors); });
    })
    .then(function (data) {
        return extension.http.webres200(constants.mime.json, JSON.stringify({ list: data, total: total }));
    })
    .catch(errdef.DeferChainKiller, function (err) {
        return err.attach;
    });
};

Sites.prototype._post = function () {
    var me = this;
    return me._accessibility()
    .then(function (httpOptions) {
        var status = httpOptions.getStatus('POST');
        if (status.isOK()) {
            if (!me.args)
                throw new errdef.DeferChainKiller(extension.http.webres400());
            if (me.filter.vendorObjId) {
                return resxutil.vendor.vendorExistence(me.filter.vendorObjId)
                .then(function (ok) {
                    if (!ok)
                        throw new errdef.DeferChainKiller(extension.http.webres400());
                });
            }
            else
                return;
        }
        else
            throw new errdef.DeferChainKiller(status.toWebres());
    })
    .then(function () {
        var create = { createdOn: new Date(), createdBy: me.operator.objId, fans: [], statusId: constants.status.siteStatus.active };
        if (me.filter.vendorObjId)
            create.vendorId = me.filter.vendorObjId;
        //name
        if (validate.valuedString(me.args.name))
            create.name = me.args.name.trim();
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //tags
        var tags = validate.tags(me.args.tags);
        if (tags)
            create.tags = tags;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //location
        if (validate.isObj(me.args.location)) {
            create.location = {};
            //address
            if (validate.valuedString(me.args.location.address))
                create.location.address = me.args.location.address.trim();
            else
                throw new errdef.DeferChainKiller(extension.http.webres400());
            //geo
            var geo = validate.geo(me.args.location.geo);
            if (geo)
                create.location.geo = geo;
            else
                throw new errdef.DeferChainKiller(extension.http.webres400());
        }
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //intro
        if (validate.value(me.args.intro)) {
            if (validate.isString(me.args.intro))
                create.intro = me.args.intro.trim();
            else
                throw new errdef.DeferChainKiller(extension.http.webres400());
        }
        else
            create.intro = '';
        //picUrl
        if (validate.url(me.args.picUrl) || validate.picBase64(me.args.picUrl))
            create.picUrl = me.args.picUrl;
        else if (validate.nullOrEmptyStr(me.args.picUrl))
            create.picUrl = config.defaultSitePicUrl;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //contact
        if (validate.value(me.args.contact)) {
            if (validate.isString(me.args.contact))
                create.contact = me.args.contact.trim();
            else
                throw new errdef.DeferChainKiller(extension.http.webres400());
        }
        else
            create.contact = '';
        //open
        var open = validate.site.validateAndAdjustOpen(me.args.open);
        if (open)
            create.open = open;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //prices
        var prices = validate.site.validateAndAdjustPrices(me.args.prices);
        if (prices)
            create.prices = prices;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //trans
        create.trans = { subway: '', bus: '' };
        if (validate.value(me.args.trans)) {
            if (validate.value(me.args.trans.subway)) {
                if (validate.isString(me.args.trans.subway))
                    create.trans.subway = me.args.trans.subway.trim();
                else
                    throw new errdef.DeferChainKiller(extension.http.webres400());
            }
            if (validate.value(me.args.trans.bus)) {
                if (validate.isString(me.args.trans.bus))
                    create.trans.bus = me.args.trans.bus.trim();
                else
                    throw new errdef.DeferChainKiller(extension.http.webres400());
            }
        }
        return imageUpload.uploadOneImageOrByPass(create, 'picUrl', create.vendorId ? ('sites/vendor' + create.vendorId.toString()) : 'novendor')
        .then(function () {
            return db.site.insertOneSite(create);
        });
    })
    .then(function (inserted) {
        return extension.http.webres200(constants.mime.plain, JSON.stringify({ id: inserted._id }), { Location: '/sites?id=' + inserted._id.toString() });
    })
    .catch(errdef.DeferChainKiller, function (err) {
        return err.attach;
    });
};

module.exports = Sites;