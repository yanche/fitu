
var db = require('dbaccess');
var bluebird = require('bluebird');
var extension = require('extension');
var constants = require('const');
var imageUpload = require('imageUpload');
var errdef = require('errdef');
var resxutil = require('resxutil');
var config = require('config');
var Resource = require('resource');
var validate = require('validate');

/*
list: [{
'personal':{
	'nickName':,
	'phone':,
	'contact':,
	'gender':
	},
'email':,
'headUrl':,
}],
total:
*/
var Users = function (webreq) {
    Resource.call(this, webreq);
    this.pageSize = extension.pagination.convPageSize(webreq.search.pageSize, config.pageSize.users.max, config.pageSize.users.min, config.pageSize.users.default);
    this.page = extension.pagination.convPage(webreq.search.page); //page starts from 0
};

Users.prototype = Object.create(Resource.prototype);

Users.prototype._accessibility = function () {
    var httpOptions = new resxutil.HttpOptions();
    httpOptions.setStatus('POST', 200);
    var me = this;
    if (me.operator) {
        return me.operator.isGodOrOb()
        .then(function (ok) {
            return httpOptions.setStatus('GET', ok ? 200 : 401);
        });
    }
    else
        return bluebird.resolve(httpOptions.setStatus('GET', 401));
};

Users.prototype._get = function () {
    var me = this, total = 0;
    return me._accessibility()
    .then(function (httpOptions) {
        var status = httpOptions.getStatus('GET');
        if (status.isOK())
            return bluebird.all([
                db.user.getUsersFieldsInPage({}, resxutil.user.getFields, { createdOn: -1 }, me.page * me.pageSize, me.pageSize),
                db.user.countUsers({})
            ]);
        else
            throw new errdef.DeferChainKiller(status.toWebres());
    })
    .then(function (data) {
        total = data[1];
        return data[0].map(function (d) { return resxutil.user.convUserInfo(d); });
    })
    .then(function (data) {
        return extension.http.webres200(constants.mime.json, JSON.stringify({ list: data, total: total }));
    })
    .catch(errdef.DeferChainKiller, function (err) {
        return err.attach;
    });
};

Users.prototype._post = function () {
    var me = this;
    return me._accessibility()
    .then(function (httpOptions) {
        var status = httpOptions.getStatus('POST');
        if (status.isOK()) {
            if (!me.args)
                throw new errdef.DeferChainKiller(extension.http.webres400());
            var create = { special: 0 };
            //email
            if (validate.email(me.args.email))
                create.email = me.args.email.toLowerCase();
            else
                throw new errdef.DeferChainKiller(extension.http.webres400());
            //hash_pwd
            if (validate.md5(me.args.hash_pwd))
                create.hash_pwd = me.args.hash_pwd.toLowerCase();
            else
                throw new errdef.DeferChainKiller(extension.http.webres400());
            //headUrl
            if (validate.url(me.args.headUrl) || validate.picBase64(me.args.headUrl))
                create.headUrl = me.args.headUrl;
            else if (validate.nullOrEmptyStr(me.args.headUrl))
                create.headUrl = config.defaultHeadUrl;
            else
                throw new errdef.DeferChainKiller(extension.http.webres400());
            //personal
            if (validate.value(me.args.personal)) {
                create.personal = {};
                //nick name
                if (validate.nickName(me.args.personal.nickName))
                    create.personal.nickName = me.args.personal.nickName;
                else if (!validate.nullOrEmptyStr(me.args.personal.headUrl))
                    throw new errdef.DeferChainKiller(extension.http.webres400());
                //phone
                if (validate.phone(me.args.personal.phone))
                    create.personal.phone = me.args.personal.phone;
                else if (!validate.nullOrEmptyStr(me.args.personal.headUrl))
                    throw new errdef.DeferChainKiller(extension.http.webres400());
                //contact
                if (validate.email(me.args.personal.contact))
                    create.personal.contact = me.args.personal.contact.toLowerCase();
                else if (!validate.nullOrEmptyStr(me.args.personal.contact))
                    throw new errdef.DeferChainKiller(extension.http.webres400());
                else
                    create.personal.contact = create.email;
                //gender
                if (validate.gender(me.args.personal.gender))
                    create.personal.gender = me.args.personal.gender;
                else if (!validate.nullOrEmptyStr(me.args.personal.gender))
                    throw new errdef.DeferChainKiller(extension.http.webres400());
                else
                    create.personal.gender = '';
            }
            else
                create.personal = { gender: '男', contact: create.email };
            return resxutil.user.checkDup(create.email, create.personal.nickName)
            .then(function (ok) {
                if (ok)
                    return imageUpload.uploadOneImageOrByPass(create, 'headUrl', 'users');
                else
                    throw new errdef.DeferChainKiller(extension.http.webres409());
            })
            .then(function () {
                return db.user.insertOneUser(create);
            });
        }
        else
            throw new errdef.DeferChainKiller(status.toWebres());
    })
    .then(function (inserted) {
        return extension.http.webres201(constants.mime.plain, '', { Location: '/users?id=' + inserted._id.toString() });
    })
    .catch(errdef.DeferChainKiller, function (err) {
        return err.attach;
    });
};

module.exports = Users;