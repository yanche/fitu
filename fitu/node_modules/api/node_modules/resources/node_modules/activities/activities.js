
var db = require('dbaccess');
var bluebird = require('bluebird');
var extension = require('extension');
var constants = require('const');
var imageUpload = require('imageUpload');
var errdef = require('errdef');
var resxutil = require('resxutil');
var config = require('config');
var Resource = require('resource');
var validate = require('validate');
var _ = require('underscore');
var infra = require('infra');

/*
list: [{
'id':,
'site': {id:, name:, location:, picUrl: },
'siteIdle': {id:, startsOn:, endsOn:, slots: },
'vendor': {id:, name:, logoUrl: },
'name':,
'startsOn':,
'endsOn':,
'createdOn':,
'createdBy':,
'tags': [],
'intro':,
'picUrl':,
'capacity':,
'price':
}],
total:
*/
//priority: site idle > site > vendor
var Activities = function (webreq) {
    var me = this;
    Resource.call(me, webreq);
    me.filter.lead = Boolean(webreq.search.lead);
    me.filter.siteIdleObjId = extension.mongo.tryConvObjId(webreq.search.siteIdleId);
    me.filter.siteObjId = extension.mongo.tryConvObjId(webreq.search.siteId);
    me.filter.vendorObjId = extension.mongo.tryConvObjId(webreq.search.vendorId);
    me.filter.tag = webreq.search.tag;
    me.badFilter = (webreq.search.siteIdleId && !me.filter.siteIdleObjId) || (webreq.search.siteId && !me.filter.siteObjId) || (webreq.search.vendorId && !me.filter.vendorObjId);
    me.pageSize = extension.pagination.convPageSize(webreq.search.pageSize, config.pageSize.activities.max, config.pageSize.activities.min, config.pageSize.activities.default);
    me.page = extension.pagination.convPage(webreq.search.page); //page starts from 0
};

Activities.prototype = Object.create(Resource.prototype);

Activities.prototype._accessibility = function () {
    var httpOptions = new resxutil.HttpOptions();
    var me = this;
    if (me.badFilter)
        return bluebird.resolve(httpOptions.setStatus('GET', 400).setStatus('POST', 400));
    else {
        httpOptions.setStatus('GET', me.filter.lead && !me.operator ? 401 : 200);
        if (!me.filter.siteObjId)
            return bluebird.resolve(httpOptions.setStatus('POST', 400));
        else if (!me.operator)
            return bluebird.resolve(httpOptions.setStatus('POST', 401));
        else {
            return me.operator.isOb()
            .then(function (ok) {
                if (ok)
                    return httpOptions.setStatus('POST', 401); //ob cannot do this, even if he is god/vendor owner
                else
                    return httpOptions.setStatus('POST', 200);
            });
        }
    }
};

Activities.prototype._get = function () {
    var me = this, activities = null, total = 0;
    return me._accessibility()
    .then(function (httpOptions) {
        var status = httpOptions.getStatus('GET');
        if (status.isOK()) {
            var getActivities = function (filter) {
                return db.activity.getActsFieldsInPage(filter, resxutil.activity.getFields, { createdOn: -1 }, me.page * me.pageSize, me.pageSize);
            };
            var countActivities = function (filter) {
                return db.activity.countActs(filter);
            };
            var getData = function (filter) {
                return bluebird.all([getActivities(filter), countActivities(filter)]);
            };
            var filter = {};
            if (me.filter.lead) filter.createdBy = me.operator.objId;
            if (me.filter.tag) filter.tags = me.filter.tag;
            if (me.filter.siteIdleObjId)
                filter.siteIdleId = me.filter.siteIdleObjId;
            else if (me.filter.siteObjId)
                filter.siteId = me.filter.siteObjId;
            else if (me.filter.vendorObjId)
                filter.vendorId = me.filter.vendorObjId;
            return getData(filter);
        }
        else
            throw new errdef.DeferChainKiller(status.toWebres());
    })
    .then(function (data) {
        activities = data[0], total = data[1];
        //TODO: optimization
        return bluebird.all([
            db.user.getUsersFieldsBy({ _id: { $in: activities.map(function (a) { return a.createdBy; }) } }, resxutil.user.getRelatedUserFields),
            db.siteidle.getSiteIdlesFieldsBy({ _id: { $in: activities.map(function (a) { return a.siteIdleId; }) } }, resxutil.siteidle.getRelatedSiteIdleFields),
            db.site.getSitesFieldsBy({ _id: { $in: activities.map(function (a) { return a.siteId; }) } }, resxutil.site.getRelatedSiteFields),
            db.vendor.getVendorsFieldsBy({ _id: { $in: activities.map(function (a) { return a.vendorId; }) } }, resxutil.vendor.getRelatedVendorFields),
            db.member.getMembersFieldsBy({ actId: { $in: activities.map(function (a) { return a._id; }) } }, { _id: 1, actId: 1 }),
            db.message.getMessagesFieldsBy({ targetId: { $in: activities.map(function (a) { return a._id; }) } }, { _id: 1, targetId: 1 })
        ]);
    })
    .then(function (data) {
        var users = data[0], siteidles = data[1], sites = data[2], vendors = data[3];
        return activities.map(function (act) {
            return resxutil.activity.convActivityInfo(act, users, siteidles, sites, vendors, data[4], data[5]);
        });
    })
    .then(function (data) {
        return extension.http.webres200(constants.mime.json, JSON.stringify({ list: data, total: total }));
    })
    .catch(errdef.DeferChainKiller, function (err) {
        return err.attach;
    });
};

Activities.prototype._post = function () {
    var me = this;
    return me._accessibility()
    .then(function (httpOptions) {
        var status = httpOptions.getStatus('POST');
        if (status.isOK()) {
            if (!me.args || !me.filter.siteObjId)
                throw new errdef.DeferChainKiller(extension.http.webres400());
            return bluebird.all([
                me.filter.siteIdleObjId ? resxutil.siteidle.siteIdleBelongsToSite(me.filter.siteIdleObjId, me.filter.siteObjId) : bluebird.resolve(true),
                me.filter.vendorObjId ? resxutil.site.siteBelongsToVendor(me.filter.siteObjId, me.filter.vendorObjId) : bluebird.resolve(true),
                resxutil.site.siteExistence(me.filter.siteObjId)
            ]);
        }
        else
            throw new errdef.DeferChainKiller(status.toWebres());
    })
    .then(function (dependencies) {
        if (dependencies[0] && dependencies[1] && dependencies[2]) {
            var create = { createdOn: new Date(), createdBy: me.operator.objId, siteId: me.filter.siteObjId };
            if (me.filter.siteIdleObjId) create.siteIdleId = me.filter.siteIdleObjId;
            if (me.filter.vendorObjId) {
                create.vendorId = me.filter.vendorObjId;
                return create;
            }
            else {
                return db.site.getOneSiteFieldsBy({ _id: me.filter.siteObjId }, { vendorId: 1 })
                        .then(function (site) {
                    create.vendorId = site.vendorId;
                    return create;
                });
            }
        }
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
    })
    .then(function (create) {
        //name
        if (validate.valuedString(me.args.name))
            create.name = me.args.name;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //price
        var price = Number(me.args.price);
        if (!isNaN(price) && price >= 0)
            create.price = me.args.price;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //startsOn
        var startsOn = new Date(me.args.startsOn);
        if (validate.valuedString(me.args.startsOn) && !isNaN(startsOn.getTime()) && startsOn.getTime() >= create.createdOn.getTime())
            create.startsOn = startsOn;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //endsOn
        var endsOn = new Date(me.args.endsOn);
        if (validate.valuedString(me.args.endsOn) && !isNaN(endsOn.getTime()) && endsOn.getTime() >= create.startsOn.getTime())
            create.endsOn = endsOn;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //tags
        var tags = validate.tags(me.args.tags);
        if (tags)
            create.tags = tags;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //intro
        if (validate.isString(me.args.intro))
            create.intro = me.args.intro;
        else if (validate.nullOrEmptyStr(me.args.intro))
            create.intro = '';
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //picUrl
        if (validate.url(me.args.picUrl) || validate.picBase64(me.args.picUrl))
            create.picUrl = me.args.picUrl;
        else if (validate.nullOrEmptyStr(me.args.picUrl))
            create.picUrl = config.defaultActivityPicUrl;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //capacity
        var capacity = Number(me.args.capacity);
        if (!isNaN(capacity) && capacity >= 0)
            create.capacity = capacity;
        else
            throw new errdef.DeferChainKiller(extension.http.webres400());
        //recruitment
        create.recruitment = [];
        return imageUpload.uploadOneImageOrByPass(create, 'picUrl', 'activities')
        .then(function () {
            return db.activity.insertOneAct(create);
        });
    })
    .then(function (inserted) {
        return extension.http.webres200(constants.mime.plain, '', { Location: '/activities?id=' + inserted._id.toString() });
    })
    .catch(errdef.DeferChainKiller, function (err) {
        return err.attach;
    });
};

module.exports = Activities;